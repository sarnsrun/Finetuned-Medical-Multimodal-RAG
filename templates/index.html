<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MedRAG | Clinical Intelligence</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            // "Ai Fiqh" style deep dark theme
            background: '#09090b', // Very dark zinc
            sidebar: '#000000',    // Pure black sidebar
            surface: '#18181b',    // Component background
            border: '#27272a',     // Subtle borders
            brand: {
              500: '#3b82f6',      // Medical Blue
              600: '#2563eb',
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #52525b; }

    /* Typing Indicator */
    .typing-dot {
      width: 6px; height: 6px; background: #71717a; border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    
    /* Fade In */
    .message-enter { animation: slideIn 0.3s ease-out forwards; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-background text-zinc-200 h-screen flex overflow-hidden text-sm antialiased selection:bg-brand-900 selection:text-brand-100">

  <aside class="w-64 bg-sidebar border-r border-border flex-col hidden md:flex">
    <div class="h-16 flex items-center px-6 border-b border-border/50">
      <div class="w-7 h-7 rounded bg-gradient-to-tr from-brand-500 to-blue-700 flex items-center justify-center mr-3 shadow-lg shadow-blue-900/20">
        <i class="fas fa-cube text-white text-xs"></i>
      </div>
      <span class="font-semibold text-lg tracking-tight text-white">MedRAG</span>
    </div>

    <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
      <button onclick="location.reload()" class="w-full flex items-center px-3 py-2.5 text-zinc-400 rounded-lg hover:bg-surface hover:text-white transition-colors group">
        <i class="fas fa-plus text-brand-500 mr-3 group-hover:text-brand-400"></i>
        New Chat
      </button>

      <div class="pt-4 pb-2 px-3 text-xs font-medium text-zinc-600 uppercase tracking-wider">History</div>
      <div class="space-y-1">
        <a href="#" class="flex items-center px-3 py-2 text-zinc-500 rounded-lg hover:bg-surface/50 hover:text-zinc-300 transition-colors truncate">
          <i class="far fa-message mr-3 text-xs opacity-50"></i> Glioblastoma treatment
        </a>
        <a href="#" class="flex items-center px-3 py-2 text-zinc-500 rounded-lg hover:bg-surface/50 hover:text-zinc-300 transition-colors truncate">
          <i class="far fa-image mr-3 text-xs opacity-50"></i> X-Ray Pleural Effusion
        </a>
      </div>
    </nav>

    <div class="p-4 border-t border-border bg-black">
      <div class="flex items-center">
        <div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center text-zinc-400 border border-zinc-700">
          <i class="fas fa-user text-xs"></i>
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium text-white">Clinical User</p>
          <p class="text-xs text-zinc-500">Research Access</p>
        </div>
      </div>
    </div>
  </aside>

  <main class="flex-1 flex flex-col h-full relative bg-background">
    
    <div class="md:hidden h-14 border-b border-border flex items-center px-4 bg-sidebar justify-between">
      <span class="font-bold text-white">MedRAG</span>
      <button class="text-zinc-400"><i class="fas fa-bars"></i></button>
    </div>

    <div id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-32 scroll-smooth">
      
      <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center text-center space-y-6 max-w-2xl mx-auto">
        <div class="w-16 h-16 rounded-2xl bg-surface border border-border flex items-center justify-center shadow-2xl shadow-black">
          <i class="fas fa-heartbeat text-3xl text-brand-500"></i>
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">Good evening, Doctor.</h1>
          <p class="text-zinc-400">I am your AI assistant for retrieval-augmented medical analysis.</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full max-w-lg mt-8">
          <button onclick="setQuickQuery('What are the treatments for glioblastoma?')" class="text-left p-4 rounded-xl bg-surface border border-border hover:border-brand-500/50 hover:bg-surface/80 transition-all group">
            <div class="text-zinc-200 font-medium mb-1 group-hover:text-brand-400">Clinical Protocols</div>
            <div class="text-xs text-zinc-500">"Treatments for glioblastoma..."</div>
          </button>
          <button onclick="toggleImageMode()" class="text-left p-4 rounded-xl bg-surface border border-border hover:border-brand-500/50 hover:bg-surface/80 transition-all group">
            <div class="text-zinc-200 font-medium mb-1 group-hover:text-brand-400">Visual Analysis</div>
            <div class="text-xs text-zinc-500">Upload scan for VQA diagnosis...</div>
          </button>
        </div>
      </div>

      </div>

    <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-background via-background to-transparent pb-6 pt-10 px-4 md:px-8">
      <div class="max-w-3xl mx-auto">
        
        <div id="modeIndicator" class="flex items-center justify-between mb-2 px-2">
          <span id="currentModeText" class="text-xs font-medium text-brand-500 uppercase tracking-widest flex items-center">
            <span class="w-2 h-2 rounded-full bg-brand-500 mr-2 animate-pulse"></span> Text Query Mode
          </span>
          <button onclick="toggleImageMode()" class="text-xs text-zinc-500 hover:text-white flex items-center transition-colors">
            <i class="fas fa-sync-alt mr-1"></i> Switch Mode
          </button>
        </div>

        <div class="relative bg-surface rounded-xl border border-border shadow-2xl shadow-black ring-1 ring-white/5 focus-within:ring-brand-500/50 focus-within:border-brand-500/50 transition-all">
          
          <form id="queryForm" class="flex items-end p-2" autocomplete="off">
            <textarea id="queryInput" rows="1" 
              class="w-full bg-transparent text-zinc-100 placeholder-zinc-500 px-4 py-3 focus:outline-none resize-none max-h-32" 
              placeholder="Ask a medical question..." required oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
            <button type="submit" class="p-3 rounded-lg bg-brand-600 text-white hover:bg-brand-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex-shrink-0 mb-0.5">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>

          <form id="captionForm" class="hidden flex flex-col p-4 space-y-3" enctype="multipart/form-data">
            <div class="relative border-2 border-dashed border-zinc-700 rounded-lg hover:bg-zinc-800/50 transition-colors cursor-pointer p-6 text-center">
              <input type="file" id="imageInput" name="image" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" required onchange="updateFileName(this)">
              <i class="fas fa-cloud-upload-alt text-2xl text-zinc-500 mb-2"></i>
              <p id="fileLabel" class="text-sm text-zinc-400">Drop medical image here or click to browse</p>
            </div>
            <div class="flex items-center space-x-2">
              <input type="text" id="imageQuestion" class="flex-1 bg-black border border-zinc-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-500" placeholder="Clinical question about image..." required>
              <button type="submit" class="px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-500 font-medium">Analyze</button>
            </div>
          </form>

        </div>
        <p class="text-center text-[10px] text-zinc-600 mt-3">
          MedRAG may produce inaccurate information about patients or protocols. Verify with a specialist.
        </p>
      </div>
    </div>

  </main>

  <script>
    let isImageMode = false;

    // --- UI HELPERS ---
    function setQuickQuery(text) {
      $('#queryInput').val(text).focus();
      // Auto submit if you want, or just let user hit enter
    }

    function toggleImageMode() {
      isImageMode = !isImageMode;
      const indicator = $('#currentModeText');
      
      if (isImageMode) {
        indicator.html('<span class="w-2 h-2 rounded-full bg-purple-500 mr-2 animate-pulse"></span> VQA Image Mode');
        $('#queryForm').addClass('hidden');
        $('#captionForm').removeClass('hidden');
      } else {
        indicator.html('<span class="w-2 h-2 rounded-full bg-brand-500 mr-2 animate-pulse"></span> Text Query Mode');
        $('#captionForm').addClass('hidden');
        $('#queryForm').removeClass('hidden');
      }
    }

    function updateFileName(input) {
      if(input.files && input.files[0]) {
        $('#fileLabel').text(input.files[0].name).addClass('text-brand-400 font-medium');
      }
    }

    function scrollToBottom() {
      const container = document.getElementById('chatContainer');
      container.scrollTop = container.scrollHeight;
    }

    function createMessage(role, content, metadata = null) {
      const isUser = role === 'user';
      const alignment = isUser ? 'justify-end' : 'justify-start';
      const bg = isUser ? 'bg-zinc-800 border border-zinc-700 text-zinc-100' : 'bg-transparent text-zinc-300 pr-8 md:pr-16';
      const avatar = isUser 
        ? '' 
        : `<div class="w-8 h-8 rounded bg-brand-600 flex-shrink-0 flex items-center justify-center mr-4 mt-1 shadow-lg shadow-blue-900/20"><i class="fas fa-cube text-white text-xs"></i></div>`;

      let metricsHtml = '';
      if (metadata && !isUser) {
        // Professional Citation / Metadata Card
        metricsHtml = `
          <div class="mt-4 pt-4 border-t border-zinc-800">
            <details class="group">
              <summary class="flex items-center text-xs font-medium text-zinc-500 cursor-pointer hover:text-brand-400 transition-colors list-none">
                <i class="fas fa-chevron-right text-[10px] mr-2 transition-transform group-open:rotate-90"></i>
                View Sources & Metrics
              </summary>
              <div class="mt-3 pl-4 border-l-2 border-zinc-800 space-y-3">
                <div>
                  <div class="text-[10px] uppercase tracking-wider text-zinc-600 font-bold mb-1">Reference Answer</div>
                  <div class="text-sm text-zinc-400 italic bg-black/30 p-2 rounded border border-zinc-800/50">
                    "${metadata.reference_answer || 'No reference available'}"
                  </div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                   <div class="bg-black p-2 rounded border border-zinc-800 text-center">
                      <div class="text-[10px] text-zinc-600 uppercase">F1 Score</div>
                      <div class="text-brand-500 font-mono font-bold">${metadata.f1_score?.toFixed(2) || '0.00'}</div>
                   </div>
                   <div class="bg-black p-2 rounded border border-zinc-800 text-center">
                      <div class="text-[10px] text-zinc-600 uppercase">Cosine</div>
                      <div class="text-brand-500 font-mono font-bold">${metadata.cosine_similarity?.toFixed(2) || '0.00'}</div>
                   </div>
                   <div class="bg-black p-2 rounded border border-zinc-800 text-center">
                      <div class="text-[10px] text-zinc-600 uppercase">Lev.</div>
                      <div class="text-brand-500 font-mono font-bold">${metadata.lev_similarity?.toFixed(2) || '0.00'}</div>
                   </div>
                </div>
                <div class="pt-2">
                   <button onclick="alert('Feedback feature coming in v1.1')" class="text-xs text-zinc-500 hover:text-orange-400 flex items-center">
                      <i class="far fa-flag mr-1"></i> Flag incorrect answer
                   </button>
                </div>
              </div>
            </details>
          </div>
        `;
      }

      return `
        <div class="flex ${alignment} message-enter">
          ${!isUser ? avatar : ''}
          <div class="${isUser ? 'max-w-2xl px-5 py-3 rounded-2xl' : 'w-full'} ${bg}">
            <div class="leading-relaxed whitespace-pre-wrap">${content}</div>
            ${metricsHtml}
          </div>
        </div>
      `;
    }

    function showTyping() {
      return `
        <div id="typingIndicator" class="flex justify-start message-enter">
          <div class="w-8 h-8 rounded bg-brand-600 flex-shrink-0 flex items-center justify-center mr-4 shadow-lg shadow-blue-900/20"><i class="fas fa-cube text-white text-xs"></i></div>
          <div class="flex items-center space-x-1 h-10">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      `;
    }

    // --- SUBMIT HANDLERS ---

    // 1. TEXT SUBMIT
    $('#queryForm').on('submit', function(e) {
      e.preventDefault();
      const input = $('#queryInput');
      const query = input.val().trim();
      if (!query) return;

      // UI Updates
      $('#welcomeScreen').hide();
      $('#chatContainer').append(createMessage('user', query));
      input.val('').css('height', 'auto');
      $('#chatContainer').append(showTyping());
      scrollToBottom();

      // API Call
      $.ajax({
        url: "/query",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ query: query }),
        success: function(res) {
          $('#typingIndicator').remove();
          $('#chatContainer').append(createMessage('ai', res.generated_answer, res));
          scrollToBottom();
        },
        error: function() {
          $('#typingIndicator').remove();
          $('#chatContainer').append(createMessage('ai', "I apologize, but I encountered an error processing your request. Please try again."));
          scrollToBottom();
        }
      });
    });

    // 2. IMAGE SUBMIT
    $('#captionForm').on('submit', function(e) {
      e.preventDefault();
      
      const question = $('#imageQuestion').val();
      const fileInput = $('#imageInput')[0];
      
      if (!fileInput.files.length || !question) return;

      // UI Updates
      $('#welcomeScreen').hide();
      $('#chatContainer').append(createMessage('user', `[Attached Image: ${fileInput.files[0].name}]\n${question}`));
      $('#chatContainer').append(showTyping());
      scrollToBottom();

      // Prepare Data
      const formData = new FormData();
      formData.append('image', fileInput.files[0]);
      formData.append('question', question);

      // API Call
      $.ajax({
        url: "/caption",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function(res) {
          $('#typingIndicator').remove();
          // Handle list reference answer
          let ref = res.reference_answer;
          if (Array.isArray(ref)) ref = ref.join(", ");
          res.reference_answer = ref; // normalize for the metadata function

          $('#chatContainer').append(createMessage('ai', res.generated_caption, res));
          scrollToBottom();
          
          // Reset form
          $('#captionForm')[0].reset();
          $('#fileLabel').text("Drop medical image here or click to browse").removeClass('text-brand-400 font-medium');
          toggleImageMode(); // Switch back to text mode automatically (optional UX choice)
        },
        error: function() {
          $('#typingIndicator').remove();
          $('#chatContainer').append(createMessage('ai', "Error analyzing the image. Please ensure it is a valid medical format."));
          scrollToBottom();
        }
      });
    });
  </script>
</body>
</html>